<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigDecimal的精度与刻度 - 独行深山</title>
    <meta name="author"  content="王君敕">
    <meta name="description" content="BigDecimal的精度与刻度">
    <meta name="keywords"  content="java">

    <meta property="og:title" content="BigDecimal的精度与刻度 - 独行深山">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wangxuan.me/tech/2024/07/16/the-precision-and-scale-of-BigDecimal.html">
    <meta property="og:description" content="去创造点什么而不是依靠别人活着">
    <meta property="og:site_name" content="独行深山">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>
<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="true">

<header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">首页</a></li>
            
            <li><a href="/tags.html">标签</a></li>
            
            <li><a href="/categories.html">分类</a></li>
            
            <li><a href="/doushuai/">兜率宫</a></li>
            
            <li><a href="/about.html">关于</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default " data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
            
            
            <a href="https://wangxuan.me/tags#java" class="post-tag">java</a>
            
            
        </div>
        <h1>BigDecimal的精度与刻度</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="https://wangxuan.me" target="_blank" rel="author">王君敕</a></></span>
            <time class="post-meta-item" datetime="24-07-16"><i class="iconfont icon-date"></i>16 Jul 2024</time>
        </div>
    </div>
    
    <div class="filter"></div>
    <div class="post-cover" style="background: url('/assets/images/20240716/cover.jpeg') center no-repeat; background-size: cover;">
    
</header>

<div class="post-content">
    
    <h2 class="post-subtitle">为什么你应该用字符串构造BigDecimal对象</h2>
    
    <article class="markdown-body">
        <p>BigDecimal是Java中用于高精度算术运算的类。当您需要精确地处理非常大或非常小的数字时，例如在金融计算中，它特别有用。由于众所周知得原因，Double这种类型在某些情况下会出现丢失精度的问题，所以在需要对较为敏感的数据(比如与金额有关的)进行运算时，我们都会用BigDecimal。但是，用BigDecimal不代表就一定没问题，我们今天就讨论一下关于BigDecimal的问题。</p>

<h2 id="精度与刻度">精度与刻度</h2>

<p>要正确使用BigDecimal，首先要清楚精度(precision)和刻度(scale)的概念。</p>

<ul>
  <li>
    <p>Precision（精度）：表示数值的总位数，包括小数点前后的位数。例如，数值 123.45 的精度是 5，因为它有 5 位数字。</p>
  </li>
  <li>
    <p>Scale（刻度）：表示小数点后的位数。例如，数值 123.45 的刻度是 2，因为小数点后有 2 位数字。</p>
  </li>
</ul>

<p>举个例子，如果一个数值类型定义为 DECIMAL(7, 2)，那么它的精度是 7，刻度是 2。这意味着这个数值最多可以有 7 位数字，其中 2 位在小数点后，5 位在小数点前。
(p.s. DECIMAL这个数值类型通常是用在数据库中的，JAVA中并没有这个类型。用这个例子是因为它可以最清晰地说明精度与刻度)</p>

<p>BigDecimal类中也有获取精度和刻度的方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">BigDecimal</span> <span class="n">num</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"12.1234"</span><span class="o">);</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"precision:%s scale:%s"</span><span class="o">,</span> <span class="n">num</span><span class="o">.</span><span class="na">precision</span><span class="o">(),</span><span class="n">num</span><span class="o">.</span><span class="na">scale</span><span class="o">()));</span>

    <span class="c1">//输出：precision:6 scale:4</span>
</code></pre></div></div>

<h2 id="除法中的刻度">除法中的刻度</h2>

<p>在用BigDecimal做除法运算，使用divide方法的时候，可以指定刻度，也可以不指定。</p>

<p>当指定刻度，即保留几位小数的时候，需要指定进位模式(RoundingMode)。
可选的模式有UP、DOWN、CEILING、FLOOR、HALF_UP、HALF_DOWN、HALF_EVEN、UNNECESSARY。
JDK api中用一个表格比较了这几种模式的区别</p>

<p><strong>Result of rounding input to one digit with the given rounding mode</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Input Number</th>
      <th style="text-align: left">UP</th>
      <th style="text-align: left">DOWN</th>
      <th style="text-align: left">CEILING</th>
      <th style="text-align: left">FLOOR</th>
      <th style="text-align: left">HALF_UP</th>
      <th style="text-align: left">HALF_DOWN</th>
      <th style="text-align: left">HALF_EVEN</th>
      <th style="text-align: left">UNNECESSARY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">5.5</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">2.5</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">1.6</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">1.1</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">1.0</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left">-1.0</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
    </tr>
    <tr>
      <td style="text-align: left">-1.1</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">-1.6</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">-2.5</td>
      <td style="text-align: left">-3</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-3</td>
      <td style="text-align: left">-3</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
    <tr>
      <td style="text-align: left">-5.5</td>
      <td style="text-align: left">-6</td>
      <td style="text-align: left">-5</td>
      <td style="text-align: left">-5</td>
      <td style="text-align: left">-6</td>
      <td style="text-align: left">-6</td>
      <td style="text-align: left">-5</td>
      <td style="text-align: left">-6</td>
      <td style="text-align: left">throw ArithmeticException</td>
    </tr>
  </tbody>
</table>

<p>按指定的规则进位，保留几位小数，这没有问题。</p>

<p>如果不指定刻度呢？</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">BigDecimal</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
	<span class="nc">BigDecimal</span> <span class="n">eight</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"8"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">one</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">eight</span><span class="o">));</span><span class="c1">//输出 0.125</span>
	<span class="nc">BigDecimal</span> <span class="n">three</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"3"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">one</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">three</span><span class="o">));</span><span class="c1">// java.lang.ArithmeticException: Non-terminating decimal expansion; no exact representable decimal result.</span>

</code></pre></div></div>
<p>当结果能除尽的时候正常处理，当除不尽即结果是无限循环小数的时候，程序抛出异常。
看一下源码：</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">BigDecimal</span> <span class="nf">divide</span><span class="o">(</span><span class="nc">BigDecimal</span> <span class="n">divisor</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*
         * Handle zero cases first.
         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">divisor</span><span class="o">.</span><span class="na">signum</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">// x/0</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">signum</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>    <span class="c1">// 0/0</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArithmeticException</span><span class="o">(</span><span class="s">"Division undefined"</span><span class="o">);</span>  <span class="c1">// NaN</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArithmeticException</span><span class="o">(</span><span class="s">"Division by zero"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Calculate preferred scale</span>
        <span class="kt">int</span> <span class="n">preferredScale</span> <span class="o">=</span> <span class="n">saturateLong</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">scale</span> <span class="o">-</span> <span class="n">divisor</span><span class="o">.</span><span class="na">scale</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">signum</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// 0/y</span>
            <span class="k">return</span> <span class="nf">zeroValueOf</span><span class="o">(</span><span class="n">preferredScale</span><span class="o">);</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/*
             * If the quotient this/divisor has a terminating decimal
             * expansion, the expansion can have no more than
             * (a.precision() + ceil(10*b.precision)/3) digits.
             * Therefore, create a MathContext object with this
             * precision and do a divide with the UNNECESSARY rounding
             * mode.
             */</span>
            <span class="nc">MathContext</span> <span class="n">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MathContext</span><span class="o">(</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">precision</span><span class="o">()</span> <span class="o">+</span>
                                                            <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="nc">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">divisor</span><span class="o">.</span><span class="na">precision</span><span class="o">()/</span><span class="mf">3.0</span><span class="o">),</span>
                                                            <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">),</span>
                                              <span class="nc">RoundingMode</span><span class="o">.</span><span class="na">UNNECESSARY</span><span class="o">);</span>
            <span class="nc">BigDecimal</span> <span class="n">quotient</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">quotient</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">divisor</span><span class="o">,</span> <span class="n">mc</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ArithmeticException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArithmeticException</span><span class="o">(</span><span class="s">"Non-terminating decimal expansion; "</span> <span class="o">+</span>
                                              <span class="s">"no exact representable decimal result."</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">int</span> <span class="n">quotientScale</span> <span class="o">=</span> <span class="n">quotient</span><span class="o">.</span><span class="na">scale</span><span class="o">();</span>

            <span class="c1">// divide(BigDecimal, mc) tries to adjust the quotient to</span>
            <span class="c1">// the desired one by removing trailing zeros; since the</span>
            <span class="c1">// exact divide method does not have an explicit digit</span>
            <span class="c1">// limit, we can add zeros too.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">preferredScale</span> <span class="o">&gt;</span> <span class="n">quotientScale</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">quotient</span><span class="o">.</span><span class="na">setScale</span><span class="o">(</span><span class="n">preferredScale</span><span class="o">,</span> <span class="no">ROUND_UNNECESSARY</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">quotient</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>MathContext mc = new MathContext( (int)Math.min(this.precision() +(long)Math.ceil(10.0*divisor.precision()/3.0),Integer.MAX_VALUE),RoundingMode.UNNECESSARY);</p>

<p>这一句算了一个刻度，然后进位方式选了UNNECESSARY。所以当除不尽的时候就抛异常了。</p>

<p>也就是说它断定，如果一个除法能除尽，它的小数位小于this.precision() +(long)Math.ceil(10.0*divisor.precision()/3.0)</p>

<blockquote>
  <p>这句话的意思是，如果 this 除以 divisor 的商是一个有限小数，那么这个小数的位数不会超过以下公式计算的结果：<br />
$a.precision() + \lceil \frac{10 \cdot b.precision}{3} \rceil$<br />
其中：<br />
•  a.precision() 是 this 的精度，即 this 的总位数。<br />
•  b.precision() 是 divisor 的精度，即 divisor 的总位数。<br />
•  ceil 是向上取整函数。<br />
这个公式的作用是估算有限小数的最大位数。具体来说，它考虑了 this 和 divisor 的精度，并通过一个比例关系来确定商的小数位数上限。<br />
举个例子，如果 this 的精度是 5，divisor 的精度是 3，那么公式计算如下：<br />
$5 + \lceil \frac{10 \cdot 3}{3} \rceil = 5 + \lceil 10 \rceil = 5 + 10 = 15$<br />
因此，商的有限小数位数不会超过 15 位。</p>
</blockquote>

<p>插一句啊，这是为什么？</p>

<p>AI是这样回答的：</p>

<blockquote>
  <p>这个公式的提出者并没有明确的记录，但它基于数论中的一些基本原理。证明这个公式需要用到基本算术定理（Fundamental Theorem of Arithmetic），即每个整数都可以唯一地分解为素数的乘积。<br />
证明思路</p>
  <ol>
    <li>有限小数的条件：<br />
一个分数 $\frac{a}{b}$只有在其分母 (b) 仅包含 2 和 5 作为素因子时，才会有一个有限小数。这是因为 10 的唯一素因子是 2 和 5。</li>
    <li>小数位数的估算：<br />
假设我们有一个分数 $\frac{a}{b}$，其中 (a) 和 (b) 是整数，并且 (b) 仅包含 2 和 5 作为素因子。我们可以将 (b) 表示为 $(2^m \times 5^n)$，其中 (m) 和 (n) 是非负整数。</li>
    <li>小数位数的上限：<br />
为了使分数 $\frac{a}{b}$ 变成一个整数，我们需要将其乘以 $(10^{\max(m, n)})$。因此，有限小数的最大位数可以通过以下公式估算：<br />
$a.precision + \lceil \frac{10 \cdot b.precision}{3} \rceil$<br />
其中 (a.precision) 是分子 (a) 的位数，(b.precision) 是分母 (b) 的位数。</li>
  </ol>
</blockquote>

<blockquote>
  <p>具体例子<br />
假设我们有两个数：<br />
•  this = 12345（精度为 5，因为有 5 位数字）<br />
•  divisor = 678（精度为 3，因为有 3 位数字）<br />
我们想知道 12345 除以 678 的商，如果是有限小数，它的小数部分最多有多少位。根据公式：<br />
$5 + \lceil \frac{10 \cdot 3}{3} \rceil = 5 + \lceil 10 \rceil = 5 + 10 = 15$
因此，12345 除以 678 的商，如果是有限小数，小数部分最多有 15 位。</p>
</blockquote>

<p>额…是数论啊？那我走，打扰了，打扰了…
<img src="/assets/images/meme/daraole.jpg" alt="" /></p>
<h2 id="为什么你应该用字符串来构造bigdecimal">为什么你应该用字符串来构造BigDecimal</h2>

<p>聪明的你应该早就发现了，BigDecimal的构造方法有很多个。应该用哪个呢？很多人都知道应该用字符串，可是为什么呢？<br />
因为，当你不用字符串的时候，会用很多意想不到的惊喜。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">BigDecimal</span> <span class="n">strnum</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"12.1234"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"precision:%s scale:%s"</span><span class="o">,</span> <span class="n">strnum</span><span class="o">.</span><span class="na">precision</span><span class="o">(),</span><span class="n">strnum</span><span class="o">.</span><span class="na">scale</span><span class="o">()));</span><span class="c1">//输出 precision:6 scale:4</span>

    <span class="nc">BigDecimal</span> <span class="n">num</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mf">12.1234</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"precision:%s scale:%s"</span><span class="o">,</span> <span class="n">num</span><span class="o">.</span><span class="na">precision</span><span class="o">(),</span><span class="n">num</span><span class="o">.</span><span class="na">scale</span><span class="o">()));</span><span class="c1">//输出precision:50 scale:48</span>
</code></pre></div></div>
<p>下面一个刻度是48，这是什么鬼？</p>

<p>再试试除法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">BigDecimal</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"0.1"</span><span class="o">);</span>
	<span class="nc">BigDecimal</span> <span class="n">eight</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"8"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">one</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">eight</span><span class="o">));</span><span class="c1">//输出 0.0125</span>

    <span class="nc">BigDecimal</span> <span class="n">_1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mf">0.1</span><span class="o">);</span>
	<span class="nc">BigDecimal</span> <span class="n">_8</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">_1</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">_8</span><span class="o">));</span><span class="c1">//输出 0.0125000000000000006938893903907228377647697925567626953125</span>
</code></pre></div></div>

<p>为什么会出现这种结果？这个原因众所周知：</p>

<blockquote>
  <p>二进制（也称为基数2）不能精确表示某些十进制数，尤其是那些在十进制中有有限小数位但在二进制中需要无限小数位的数。例如，0.1 和 0.2 在二进制中无法精确表示。<br />
这是因为二进制系统只能使用 0 和 1 来表示数值，而某些十进制数在转换为二进制时会变成无限循环小数。例如：<br />
•  0.1 在二进制中表示为 0.00011001100110011…（无限循环）<br />
•  0.2 在二进制中表示为 0.0011001100110011…（无限循环）<br />
由于计算机的存储空间有限，这些无限循环小数只能被截断，从而导致精度损失。这就是为什么在使用浮点数进行计算时，可能会出现精度问题。</p>
</blockquote>

<p>如果你看源码你会发现 public BigDecimal(double val) 和  public BigDecimal(String val)的实现完全不同。或许你也会想为什么呢？为什么要实现两套不同的呢？你就直接这样：</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="kt">double</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">val</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>不就完了？</p>

<p>至于JDK团队实现两套的原因是什么？你知道吗？欢迎留言告诉我:)</p>


    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="https://wangxuan.me/assets/img/profile.png" alt="">
        </div>
        <div class="author-name" rel="author">王君敕</div>
        <div class="bio">
            <p>交流，讨论，分享； 思考，总结，沉淀</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="//weibo.com/halfg0d" target="_blank">
                    <i class="iconfont icon-weibo"></i>
                </a>
            </li>
            
            <li>
                <a href="//douban.com/people/stardust1900" target="_blank">
                    <i class="iconfont icon-douban"></i>
                </a>
            </li>
            
            <li>
                <a href="//twitter.com/halfg0d" target="_blank">
                    <i class="iconfont icon-twitter"></i>
                </a>
            </li>
            
            <li>
                <a href="//github.com/stardust1900" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        <div class="read-next-item">
            <a href="/tech/2024/07/19/chinese-poem.html" class="read-next-link"></a>
            <section>
                <span>拼拼古诗</span>
                <p>去年(2023年)年底我初学flutter，看了一些文档和教程，想找个东西来练练手。</p>
            </section>
            
            <div class="filter"></div>
            <img src="/assets/images/20240719/p5.jpg" alt="">
            
        </div>
        
        
        <div class="read-next-item">
            <a href="/notes/2024/07/14/The-Gates-of-Europe.html" class="read-next-link"></a>
            <section>
                <span>欧洲之门</span>
                <p>  一些人相信，特洛伊战争的英雄、荷马的《伊利亚特》的主角阿喀琉斯（Achilles）就长眠在多瑙河或第聂伯河河口...</p>
            </section>
            
            <div class="filter"></div>
            <img src="/assets/images/20240714/cover.jpg" alt="">
            
        </div>
        
    </section>
        <section class="post-footer-item comment">
        <div id="disqus_thread">
            <script src="https://utteranc.es/client.js"
                    repo="stardust1900/stardust1900.github.io"
                    issue-term="title"
                    label="comment"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>
        </div>
    </section>
</section>

<footer class="g-footer">
    <section>
        <a href="/rss.xml" target="_blank">
        <!-- SVG图标代码 -->
        <svg t="1718768161045" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4251" width="15" height="15">
            <path d="M42.666667 853.333333a128 128 0 1 1 256 0 128 128 0 0 1-256 0z m938.666666 128h-178.773333c0-418.986667-340.906667-759.893333-759.893333-759.893333V42.666667c517.546667 0 938.666667 421.12 938.666666 938.666666z m-298.666666 0h-182.826667c0-252.074667-205.098667-457.130667-457.173333-457.130666V341.333333c352.896 0 640 287.104 640 640z" fill="#EE802F" p-id="4252">
            </path>
        </svg>
        </a>
        独行深山 © 2024
    </section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>

<script src="/assets/js/social-share.min.js"></script>
<script>
    
    socialShare('.social-share', {
        sites: ['wechat','weibo','douban','twitter'],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
    });
    
</script>

<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="/assets/js/prism.js"></script>
<script src="/assets/js/index.min.js"></script>

</body>
</html>
